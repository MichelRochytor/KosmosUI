#!/bin/bash

HERE="$(dirname "$(readlink -f "${0}")")"
export PATH="$HERE/usr/bin:$PATH"
export LD_LIBRARY_PATH="$HERE/usr/lib:$HERE/usr/lib64:$LD_LIBRARY_PATH"
export WINEPREFIX="$HOME/.wine_kosmos_pro"
mkdir -p "$WINEPREFIX"

export WINEDEBUG=-all
export WINEARCH=win64

# Inicialização pesada (apenas na primeira vez)
if [ ! -f "$WINEPREFIX/configured" ]; then
    echo "Inicializando prefixo Wine..."
    "$HERE/usr/bin/wineboot" -u
    touch "$WINEPREFIX/configured"
fi

# --- APLICAR TEMA WINDOWS 11 FLAT (SEMPRE) ---
# CORREÇÃO: Voltamos Managed="Y" para integrar com a barra de tarefas do Linux
echo "Aplicando tema moderno..."
cat <<REG > "$WINEPREFIX/config.reg"
REGEDIT4

[HKEY_CURRENT_USER\Control Panel\Desktop]
"LogPixels"=dword:00000078
"FontSmoothing"="2"
"FontSmoothingType"=dword:00000002
"ForegroundLockTimeout"=dword:00000000

[HKEY_CURRENT_USER\Software\Wine\X11 Driver]
"Decorated"="Y"
"Managed"="Y"
"UseTakeFocus"="N"

[HKEY_CURRENT_USER\Control Panel\Colors]
"ActiveBorder"="200 200 200"
"ActiveTitle"="255 255 255"
"AppWorkspace"="255 255 255"
"Background"="255 255 255"
"ButtonAlternateFace"="255 255 255"
"ButtonDkShadow"="160 160 160"
"ButtonFace"="243 243 243"
"ButtonHilight"="255 255 255"
"ButtonLight"="243 243 243"
"ButtonShadow"="200 200 200"
"ButtonText"="0 0 0"
"GradientActiveTitle"="255 255 255"
"GradientInactiveTitle"="243 243 243"
"GrayText"="120 120 120"
"Hilight"="0 120 215"
"HilightText"="255 255 255"
"HotTrackingColor"="0 102 204"
"InactiveBorder"="243 243 243"
"InactiveTitle"="243 243 243"
"InactiveTitleText"="120 120 120"
"InfoText"="0 0 0"
"InfoWindow"="255 255 255"
"Menu"="255 255 255"
"MenuBar"="243 243 243"
"MenuHilight"="230 230 230"
"MenuText"="0 0 0"
"Scrollbar"="243 243 243"
"TitleText"="0 0 0"
"Window"="255 255 255"
"WindowFrame"="200 200 200"
"WindowText"="0 0 0"

[HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\FontSubstitutes]
"MS Shell Dlg"="Segoe UI"
"MS Shell Dlg 2"="Segoe UI"
"Tahoma"="Segoe UI"
"Arial"="Segoe UI"
REG

"$HERE/usr/bin/regedit" /S "$WINEPREFIX/config.reg"
# --------------------------------------

"$HERE/usr/bin/wine" "$HERE/usr/bin/KosmosApp.exe" "$@"
